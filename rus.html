<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSON to Excel Converter with exceljs</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 50px;
      }
      .upload-btn {
        padding: 10px 20px;
        background-color: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
      }
      .upload-btn:hover {
        background-color: #45a049;
      }
      #error {
        color: red;
      }
      #success {
        color: green;
      }
    </style>
  </head>
  <body>
    <h1>Upload JSON to Convert to Excel</h1>
    <a href="./index.html">O'zbekcha</a>
    <input type="file" id="jsonFile" accept=".json" />
    <button class="upload-btn" onclick="convertToExcel()">
      Upload and Convert
    </button>
    <p id="error"></p>
    <p id="success"></p>

    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
    <script>
      function convertToExcel() {
        const fileInput = document.getElementById("jsonFile");
        const errorP = document.getElementById("error");
        const successP = document.getElementById("success");

        if (!fileInput.files[0]) {
          errorP.textContent = "Please select a JSON file!";
          return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async function (e) {
          try {
            const jsonData = JSON.parse(e.target.result);

            if (
              !jsonData.date ||
              !jsonData.teacher ||
              !jsonData.maxScores ||
              !jsonData.students
            ) {
              throw new Error(
                "Invalid JSON format! Expected fields: date, teacher, maxScores, students"
              );
            }

            const tasks = Object.keys(jsonData.maxScores).sort();
            const numTasks = tasks.length;
            const totalColumns = 2 + numTasks + 4; // №, Name, Tasks, Jami ball, Jami, Foizda, Jami foiz

            // Define column positions dynamically
            const jamiBallColNum = 2 + numTasks + 1; // After tasks
            const jamiColNum = jamiBallColNum + 1;
            const foizdaColNum = jamiColNum + 1;
            const jamiFoizColNum = foizdaColNum + 1;

            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("Sheet1");

            // Set column widths
            const columns = [
              { width: 10 }, // №
              { width: 28.5 }, // Name
            ];
            for (let i = 0; i < numTasks; i++) {
              columns.push({ width: 10 }); // Task columns
            }
            columns.push({ width: 10 }); // Jami ball
            columns.push({ width: 10 }); // Jami
            columns.push({ width: 12 }); // Foizda
            columns.push({ width: 10 }); // Jami foiz
            worksheet.columns = columns;

            // Top header row
            const headerText = `Государственное специализированное общеобразовательная школа №300 критерии и анализ СОЧ №3 \n Отчет учащихся 7 В класса по технологии за 2024-2025 гг. четверть 3.\n РЕЗУЛЬТАТЫ ОТЧЕТА.`;
            const topHeaderRow = worksheet.addRow([headerText]);
            topHeaderRow.height = 200;
            worksheet.mergeCells(1, 1, 1, totalColumns);
            const topHeaderCell = worksheet.getCell("A1");
            topHeaderCell.alignment = {
              horizontal: "center",
              vertical: "middle",
              wrapText: true,
            };
            topHeaderCell.font = { size: 20, bold: true };
            topHeaderCell.fill = {
              type: "pattern",
              pattern: "solid",
              fgColor: { argb: "DDEBF6" },
            };
            topHeaderCell.border = {
              top: { style: "thin", color: { argb: "FF000000" } },
              left: { style: "thin", color: { argb: "FF000000" } },
              bottom: { style: "thin", color: { argb: "FF000000" } },
              right: { style: "thin", color: { argb: "FF000000" } },
            };

            // Calculate participants
            const totalStudents = jsonData.students.length;
            const disqualifiedStudents = jsonData.students.filter(
              (student) => student.disqualified
            ).length;
            const participants = totalStudents - disqualifiedStudents;
            const nonParticipants = disqualifiedStudents;

            // Qatnashdi row
            const qatnashdiRow = worksheet.addRow([
              "Присутствовали",
              participants,
            ]);
            qatnashdiRow.height = 20;
            worksheet.mergeCells(2, 1, 2, totalColumns - 1);
            worksheet.getCell("A2").alignment = {
              horizontal: "left",
              vertical: "middle",
            };
            worksheet.getCell("A2").font = { size: 12, bold: true };
            worksheet.getCell("A2").border = {
              top: { style: "thin", color: { argb: "FF000000" } },
              left: { style: "thin", color: { argb: "FF000000" } },
              bottom: { style: "thin", color: { argb: "FF000000" } },
              right: { style: "thin", color: { argb: "FF000000" } },
            };
            const qatnashdiValueCell = worksheet.getCell(2, totalColumns);
            qatnashdiValueCell.value = participants;
            qatnashdiValueCell.alignment = {
              horizontal: "center",
              vertical: "middle",
            };
            qatnashdiValueCell.font = { size: 12, bold: true };
            qatnashdiValueCell.border = {
              top: { style: "thin", color: { argb: "FF000000" } },
              left: { style: "thin", color: { argb: "FF000000" } },
              bottom: { style: "thin", color: { argb: "FF000000" } },
              right: { style: "thin", color: { argb: "FF000000" } },
            };

            // Qatnashmadi row
            const qatnashmadiRow = worksheet.addRow([
              "Отсутствовали",
              nonParticipants,
            ]);
            qatnashmadiRow.height = 20;
            worksheet.mergeCells(3, 1, 3, totalColumns - 1);
            worksheet.getCell("A3").alignment = {
              horizontal: "left",
              vertical: "middle",
            };
            worksheet.getCell("A3").font = { size: 12, bold: true };
            worksheet.getCell("A3").border = {
              top: { style: "thin", color: { argb: "FF000000" } },
              left: { style: "thin", color: { argb: "FF000000" } },
              bottom: { style: "thin", color: { argb: "FF000000" } },
              right: { style: "thin", color: { argb: "FF000000" } },
            };
            const qatnashmadiValueCell = worksheet.getCell(3, totalColumns);
            qatnashmadiValueCell.value = nonParticipants;
            qatnashmadiValueCell.alignment = {
              horizontal: "center",
              vertical: "middle",
            };
            qatnashmadiValueCell.font = { size: 12, bold: true };
            qatnashmadiValueCell.border = {
              top: { style: "thin", color: { argb: "FF000000" } },
              left: { style: "thin", color: { argb: "FF000000" } },
              bottom: { style: "thin", color: { argb: "FF000000" } },
              right: { style: "thin", color: { argb: "FF000000" } },
            };

            // Info row
            const infoRow = worksheet.addRow([
              `Дата: ${jsonData.date}        учитель по предмету: ${jsonData.teacher}`,
            ]);
            infoRow.height = 20;
            worksheet.mergeCells(4, 1, 4, totalColumns);
            const infoCell = worksheet.getCell("A4");
            infoCell.alignment = {
              horizontal: "center",
              vertical: "middle",
              wrapText: true,
            };
            infoCell.font = { size: 12, bold: true };
            infoCell.border = {
              top: { style: "thin", color: { argb: "FF000000" } },
              left: { style: "thin", color: { argb: "FF000000" } },
              bottom: { style: "thin", color: { argb: "FF000000" } },
              right: { style: "thin", color: { argb: "FF000000" } },
            };

            // Empty row
            worksheet.addRow(Array(totalColumns).fill(""));

            // Table header row
            const headerRow = ["№", "Фамилия имя ученика"];
            tasks.forEach((taskKey, index) => {
              //   const taskNumber = index + 1;
              //   const maxScore = jsonData.maxScores[taskKey];
              //   headerRow.push(`${taskNumber}-задание ${maxScore} балл`);
              const maxScore = jsonData.maxScores[taskKey];
              if (index < 3) {
                // Первые три задачи как подзадачи "1 задание (1)", "1 задание (2)", "1 задание (3)"
                const subtaskNumber = index + 1;
                headerRow.push(`1 задание (${subtaskNumber}) ${maxScore} балл`);
              } else {
                // Остальные задачи нумеруются с "2 задание"
                const taskNumber = index - 1; // -1 потому что первые 3 задачи объединены в "1 задание"
                headerRow.push(`${taskNumber} задание ${maxScore} балл`);
              }
            });
            headerRow.push(
              "Итог",
              "Общий балл",
              "В процентах",
              "Общий процент"
            );
            const headerRowObj = worksheet.addRow(headerRow);
            headerRowObj.height = 60;

            headerRowObj.eachCell((cell, colNumber) => {
              cell.border = {
                top: { style: "thin", color: { argb: "FF000000" } },
                left: { style: "thin", color: { argb: "FF000000" } },
                bottom: { style: "thin", color: { argb: "FF000000" } },
                right: { style: "thin", color: { argb: "FF000000" } },
              };
              cell.alignment = {
                horizontal: "center",
                vertical: "middle",
                wrapText: true,
              };
              if (
                colNumber === jamiBallColNum ||
                colNumber === jamiFoizColNum
              ) {
                cell.fill = {
                  type: "pattern",
                  pattern: "solid",
                  fgColor: { argb: "DDEBF6" },
                };
              }
            });

            const maxTotalScore = tasks.reduce(
              (sum, taskKey) => sum + jsonData.maxScores[taskKey],
              0
            );

            jsonData.students.forEach((student, index) => {
              const rowData = [student.id, student.name];
              tasks.forEach((taskKey) => {
                rowData.push(student.scores[taskKey] || 0);
              });
              rowData.push("", "", "", ""); // Empty cells for calculations
              const row = worksheet.addRow(rowData);
              row.height = 20;

              row.eachCell((cell, colNumber) => {
                cell.border = {
                  top: { style: "thin", color: { argb: "FF000000" } },
                  left: { style: "thin", color: { argb: "FF000000" } },
                  bottom: { style: "thin", color: { argb: "FF000000" } },
                  right: { style: "thin", color: { argb: "FF000000" } },
                };
                cell.alignment = {
                  horizontal: "center",
                  vertical: "middle",
                  wrapText: true,
                };
                if (
                  colNumber === jamiBallColNum ||
                  colNumber === jamiFoizColNum
                ) {
                  cell.fill = {
                    type: "pattern",
                    pattern: "solid",
                    fgColor: { argb: "DDEBF6" },
                  };
                }
              });

              if (student.disqualified) {
                const startCol = 3;
                const endCol = totalColumns;
                worksheet.mergeCells(row.number, startCol, row.number, endCol);
                const mergedCell = worksheet.getCell(row.number, startCol);
                mergedCell.value = "DQ";
                mergedCell.fill = {
                  type: "pattern",
                  pattern: "solid",
                  fgColor: { argb: "FFFFFF00" },
                };
                mergedCell.font = { color: { argb: "FF000000" } };
                mergedCell.alignment = {
                  horizontal: "center",
                  vertical: "middle",
                };
              } else {
                const startTaskCol = 3;
                const endTaskCol = startTaskCol + numTasks - 1;

                row.getCell(jamiBallColNum).value = {
                  formula: `SUM(${excelColumnName(startTaskCol)}${
                    row.number
                  }:${excelColumnName(endTaskCol)}${row.number})`,
                };
                row.getCell(jamiColNum).value = maxTotalScore;
                row.getCell(foizdaColNum).value = {
                  formula: `${excelColumnName(jamiBallColNum)}${
                    row.number
                  }/${excelColumnName(jamiColNum)}${row.number}`,
                };
                row.getCell(foizdaColNum).numFmt = "0%";
                row.getCell(jamiFoizColNum).value = 1;
                row.getCell(jamiFoizColNum).numFmt = "0%";
              }
            });

            // Average scores row
            const avgRowData = ["", "Средний балл"];
            tasks.forEach((taskKey, index) => {
              const taskCol = 3 + index;
              const firstStudentRow = 7;
              const lastStudentRow = jsonData.students.length + 6;
              avgRowData.push({
                formula: `AVERAGEIF(${excelColumnName(
                  2
                )}${firstStudentRow}:${excelColumnName(
                  2
                )}${lastStudentRow}, "<>DQ", ${excelColumnName(
                  taskCol
                )}${firstStudentRow}:${excelColumnName(
                  taskCol
                )}${lastStudentRow})`,
              });
            });
            avgRowData.push("", "", "", "");
            const avgRow = worksheet.addRow(avgRowData);
            avgRow.height = 20;
            avgRow.eachCell((cell, colNumber) => {
              cell.border = {
                top: { style: "thin", color: { argb: "FF000000" } },
                left: { style: "thin", color: { argb: "FF000000" } },
                bottom: { style: "thin", color: { argb: "FF000000" } },
                right: { style: "thin", color: { argb: "FF000000" } },
              };
              cell.alignment = {
                horizontal: "center",
                vertical: "middle",
                wrapText: true,
              };
              if (colNumber === 2) {
                cell.font = { bold: true };
              }
              if (colNumber >= 3 && colNumber < 3 + numTasks) {
                cell.numFmt = "0.0";
              }
              if (
                colNumber === jamiBallColNum ||
                colNumber === jamiFoizColNum
              ) {
                cell.fill = {
                  type: "pattern",
                  pattern: "solid",
                  fgColor: { argb: "DDEBF6" },
                };
              }
            });

            // Mastery percentage row
            const masteryRowData = ["", "Процент усвоения:"];
            tasks.forEach((taskKey, index) => {
              const taskCol = 3 + index;
              const maxScore = jsonData.maxScores[taskKey];
              const firstStudentRow = 7;
              const lastStudentRow = jsonData.students.length + 6;
              masteryRowData.push({
                formula: `AVERAGEIF(${excelColumnName(
                  2
                )}${firstStudentRow}:${excelColumnName(
                  2
                )}${lastStudentRow}, "<>DQ", ${excelColumnName(
                  taskCol
                )}${firstStudentRow}:${excelColumnName(
                  taskCol
                )}${lastStudentRow})/${maxScore}`,
              });
            });
            masteryRowData.push("", "", "", "");
            const masteryRow = worksheet.addRow(masteryRowData);
            masteryRow.height = 20;
            masteryRow.eachCell((cell, colNumber) => {
              cell.border = {
                top: { style: "thin", color: { argb: "FF000000" } },
                left: { style: "thin", color: { argb: "FF000000" } },
                bottom: { style: "thin", color: { argb: "FF000000" } },
                right: { style: "thin", color: { argb: "FF000000" } },
              };
              cell.alignment = {
                horizontal: "center",
                vertical: "middle",
                wrapText: true,
              };
              if (colNumber === 2) {
                cell.font = { bold: true };
              }
              if (colNumber >= 3 && colNumber < 3 + numTasks) {
                cell.numFmt = "0%";
              }
              if (
                colNumber === jamiBallColNum ||
                colNumber === jamiFoizColNum
              ) {
                cell.fill = {
                  type: "pattern",
                  pattern: "solid",
                  fgColor: { argb: "DDEBF6" },
                };
              }
            });

            // Empty row
            worksheet.addRow(Array(totalColumns).fill(""));

            // Adjust outer table borders
            worksheet.getRow(5).eachCell((cell) => {
              cell.border = {
                top: { style: "thin", color: { argb: "FF000000" } },
                left: { style: "thin", color: { argb: "FF000000" } },
                bottom: { style: "thin", color: { argb: "FF000000" } },
                right: { style: "thin", color: { argb: "FF000000" } },
              };
            });
            worksheet.getRow(worksheet.rowCount).eachCell((cell) => {
              cell.border = {
                top: { style: "thin", color: { argb: "FF000000" } },
                left: { style: "thin", color: { argb: "FF000000" } },
                bottom: { style: "thin", color: { argb: "FF000000" } },
                right: { style: "thin", color: { argb: "FF000000" } },
              };
            });
            worksheet.getColumn(1).eachCell((cell) => {
              cell.border = {
                top: { style: "thin", color: { argb: "FF000000" } },
                left: { style: "thin", color: { argb: "FF000000" } },
                bottom: { style: "thin", color: { argb: "FF000000" } },
                right: { style: "thin", color: { argb: "FF000000" } },
              };
            });
            worksheet.getColumn(totalColumns).eachCell((cell) => {
              cell.border = {
                top: { style: "thin", color: { argb: "FF000000" } },
                left: { style: "thin", color: { argb: "FF000000" } },
                bottom: { style: "thin", color: { argb: "FF000000" } },
                right: { style: "thin", color: { argb: "FF000000" } },
              };
            });

            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], {
              type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            // Получаем имя файла и заменяем .json на .xlsx
            const fileName = file.name.replace(/\.json$/, ".xlsx");
            a.download = fileName;
            a.click();
            window.URL.revokeObjectURL(url);
            successP.textContent = "Excel file generated successfully!";
          } catch (err) {
            errorP.textContent = err.message;
          }
        };
        reader.readAsText(file);
      }

      function excelColumnName(colNumber) {
        let columnName = "";
        while (colNumber > 0) {
          let remainder = (colNumber - 1) % 26;
          columnName = String.fromCharCode(65 + remainder) + columnName;
          colNumber = Math.floor((colNumber - 1) / 26);
        }
        return columnName;
      }
    </script>
  </body>
</html>
